name: Sanitizer Benchmark

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: benchmark-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        path: pr-branch

    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        path: main-branch

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install PR dependencies
      run: |
        cd pr-branch
        uv sync --extra test

    - name: Install main dependencies
      continue-on-error: true
      run: |
        cd main-branch
        uv sync --extra test

    - name: Run PR benchmarks
      run: |
        cd pr-branch
        uv run python benchmarks/bench_sanitizer.py --output /tmp/bench-pr.json

    - name: Run main benchmarks
      id: main-bench
      continue-on-error: true
      run: |
        cd main-branch
        if [ -f benchmarks/bench_sanitizer.py ]; then
          uv run python benchmarks/bench_sanitizer.py --output /tmp/bench-main.json
        else
          echo "skip=true" >> "$GITHUB_OUTPUT"
        fi

    - name: Generate comparison
      run: |
        cd pr-branch
        if [ -f /tmp/bench-main.json ]; then
          uv run python benchmarks/bench_sanitizer.py \
            --compare /tmp/bench-main.json /tmp/bench-pr.json > /tmp/bench-comment.md
        else
          uv run python benchmarks/bench_sanitizer.py \
            --compare-single /tmp/bench-pr.json > /tmp/bench-comment.md
        fi

    - name: Post or update PR comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const body = fs.readFileSync('/tmp/bench-comment.md', 'utf8');
          const marker = '<!-- sanitizer-benchmark -->';
          const fullBody = marker + '\n' + body;

          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const existing = comments.find(c => c.body.includes(marker));

          if (existing) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existing.id,
              body: fullBody,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: fullBody,
            });
          }
