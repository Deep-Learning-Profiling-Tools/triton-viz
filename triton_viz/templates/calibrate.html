<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mouse Calibration</title>
    <style>
        body { margin:0; background:#111; color:#ddd; font-family: Arial, sans-serif; }
        #panel { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 8px 10px; border-radius: 6px; }
        button { margin-right: 6px; }
        #info { margin-top: 6px; opacity: 0.9; }
        canvas { display:block; margin: 0 auto; outline: 1px solid #333; }
    </style>
</head>
<body>
    <div id="panel">
        <div>点击每个目标中心点进行采样（至少 4 次）。</div>
        <div id="info">样本: 0 | dx=0, dy=0</div>
        <button id="reset">重置</button>
        <button id="apply">应用校准</button>
    </div>
    <canvas id="cv" width="800" height="500"></canvas>
    <script type="module">
    const cv = document.getElementById('cv');
    const ctx = cv.getContext('2d');
    const info = document.getElementById('info');
    const resetBtn = document.getElementById('reset');
    const applyBtn = document.getElementById('apply');

    const targets = [
        {x:150,y:120},{x:400,y:120},{x:650,y:120},
        {x:150,y:360},{x:400,y:360},{x:650,y:360}
    ];
    let samples = [];

    function draw(){
        ctx.clearRect(0,0,cv.width,cv.height);
        // grid
        ctx.strokeStyle = '#222';
        for(let x=0;x<cv.width;x+=20){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,cv.height); ctx.stroke(); }
        for(let y=0;y<cv.height;y+=20){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cv.width,y); ctx.stroke(); }
        // targets
        targets.forEach(t=>{
            ctx.fillStyle = '#0ff';
            ctx.fillRect(t.x-6,t.y-6,12,12);
            ctx.strokeStyle = '#08f';
            ctx.strokeRect(t.x-10,t.y-10,20,20);
        });
        // clicks
        samples.forEach(s=>{
            ctx.fillStyle = '#ff0';
            ctx.beginPath(); ctx.arc(s.px,s.py,4,0,Math.PI*2); ctx.fill();
        });
    }

    function computeDxDy(){
        if(samples.length === 0) return {dx:0,dy:0};
        let sumDx=0,sumDy=0,n=0;
        for(const s of samples){
            sumDx += (s.tx - s.px);
            sumDy += (s.ty - s.py);
            n++;
        }
        return {dx: Math.round(sumDx/n), dy: Math.round(sumDy/n)};
    }

    cv.addEventListener('click', (e)=>{
        const rect = cv.getBoundingClientRect();
        const px = e.clientX - rect.left;
        const py = e.clientY - rect.top;
        // pick nearest target
        let best=null, bestd=1e9;
        for(const t of targets){
            const d=(t.x-px)**2+(t.y-py)**2; if(d<bestd){best={tx:t.x,ty:t.y}; bestd=d;}
        }
        samples.push({px,py, ...best});
        const {dx,dy} = computeDxDy();
        info.textContent = `样本: ${samples.length} | dx=${dx}, dy=${dy}`;
        draw();
    });

    resetBtn.addEventListener('click', ()=>{
        samples = []; info.textContent = '样本: 0 | dx=0, dy=0'; draw();
    });

    applyBtn.addEventListener('click', ()=>{
        const {dx,dy} = computeDxDy();
        localStorage.setItem('viz_mouse_dx', String(dx));
        localStorage.setItem('viz_mouse_dy', String(dy));
        alert(`已应用校准: dx=${dx}, dy=${dy}`);
    });

    draw();
    </script>
    </body>
    </html>
