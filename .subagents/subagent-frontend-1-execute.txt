OpenAI Codex v0.89.0 (research preview)
--------
workdir: /home/trtx/College/keren/triton-viz/cr-frontend-1
model: gpt-5.2-codex
provider: openai
approval: never
sandbox: danger-full-access
reasoning effort: high
reasoning summaries: auto
session id: 019bf44c-b299-7ad2-a822-3e6d553b60f9
--------
user
Activate the skill 'ai-execute'.
Your task is frontend-1.
Follow these instructions: Base branch is viz-ts. Implement the task exactly per the Plan in tasks/code-backlog/frontend-1_remove-grid-overview.md. Keep other UI intact. Commit all changes on cr/frontend-1. If tests are added, run them and include results.

When finished, provide a concise summary of your work and the outcome (COMPLETED or ABORTED).
mcp startup: no servers

thinking
**Preparing to use execution skill**
exec
/bin/bash -lc ls in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 50ms:
ARCHITECTURE.md
LICENSE
Logo.jpg
MANUAL.md
README.md
examples
mypy.ini
pyproject.toml
pytest.ini
setup.py
tasks
tests
triton_viz
exec
/bin/bash -lc 'cat /home/trtx/.codex/skills/ai-execute/SKILL.md' in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
---
name: ai-execute
description: Autonomous-only (AI-Loop protocol) skill that claims a planned task, creates a CR worktree, implements code/tests/docs per plan, and submits for review without merging. Reserved for AI autonomous coding; do not use for human+AI.
metadata:
  short-description: Implement one task end-to-end
---

# Protocol

### Canonical task tracker
- `tasks/` is the **single source of truth** for tasks, status, ownership, dependencies, and coordination metadata.
- Task state is defined by directory:
  - `tasks/todo/` pending, unplanned
  - `tasks/code-backlog/` planned or in-progress coding work
  - `tasks/review-backlog/` awaiting review
  - `tasks/review-fix-backlog/` awaiting review fixes
  - `tasks/integrator-backlog/` approved, awaiting merge
  - `tasks/done/` merged and complete

### Claiming and locking

thinking
**Checking task and branch context**
exec
/bin/bash -lc 'cat /home/trtx/College/keren/triton-viz/cr-frontend-1/tasks/code-backlog/frontend-1_remove-grid-overview.md' in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
# Task: remove grid overview UI, keep active program workflow

Context: remove the click-to-open grid UI; default to opening program (0,0,0) and keep the Tensor/Flow views, control sidebar (Program IDs filters X/Y/Z, op controls, code peek panel), and shape legend unchanged.

Review-Round: 0
Owner:
Deps: [frontend-0]
Touches: triton_viz/static/visualization.js, triton_viz/static/gridblock.js, triton_viz/templates/index.html, triton_viz/static/visualizer.css, triton_viz/ARCHITECTURE.md, ARCHITECTURE.md, MANUAL.md, README.md
Acceptance:
- no grid overview canvas or click-to-open grid remains in the UI
- program (0,0,0) opens by default and Program IDs sliders update the active program
- op tabs, Tensor View, Flow View, code peek, and shape legend still work
Notes: Plan section is the low-level plan; use it verbatim without replacement.
Priority: P0

Plan:
- Overview: replace grid overview rendering with a lightweight active program controller that drives the op workspace directly.
- Mental model: the grid canvas and block UI are only for selection; the detail workspace and op visualizers are the real UI to preserve.
- Interfaces / contracts: preserve `visualization_data` key format and existing DOM IDs; keep code panel hooks until refactor.
- Files / functions / data structures: refactor `triton_viz/static/visualization.js` to remove KernelGrid; extract op workspace from `triton_viz/static/gridblock.js` into a new module (e.g., `op_workspace.js`); update `triton_viz/templates/index.html` and `triton_viz/static/visualizer.css` if canvas is removed.

thinking
**Verifying dependency on frontend-0**

I'm confirming that the dependency on frontend-0 is correctly declared in tasks/done before proceeding.
exec
/bin/bash -lc 'ls /home/trtx/College/keren/triton-viz/cr-frontend-1/tasks/done | rg "frontend-0"' in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
frontend-0_remove-flip-viz.md

thinking
**Verifying Git worktree existence**

I'm confirming that the current directory corresponds to an existing git worktree, checking that cr-frontend-1 is properly set up under the expected base directory.
exec
/bin/bash -lc 'git worktree list' in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
/home/trtx/College/keren/triton-viz/main           8f5b30e [main]
/home/trtx/College/keren/triton-viz/cr-frontend-1  118badc [cr/frontend-1]
/home/trtx/College/keren/triton-viz/viz-ts         be4c85f [viz-ts]

thinking
**Reviewing related frontend files**

I'm preparing to inspect visualization.js, gridblock.js, and other related frontend files to understand the existing style and structure before starting development. I'll form a minimal internal plan based on this review.
exec
/bin/bash -lc "sed -n '1,240p' triton_viz/static/visualization.js" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 50ms:
import { GridBlock } from './gridblock.js';

let globalData;
let currentView = 'main';
let canvas;
let ctx;
let canvasWrapper;
let canvasLogicalWidth = 0;
let canvasLogicalHeight = 0;
let kernelGrid;
let currentBlockData = null;
let containerElement;
let isInitialized = false;
let maxX = 0;
let maxY = 0;
let maxZ = 0;
let zSlice = 0;
const filterValues = [0, 0, 0];
const THEME_STORAGE_KEY = 'triton-viz-theme';

exec
/bin/bash -lc "sed -n '1,260p' triton_viz/static/gridblock.js" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
import { createMatMulVisualization } from './matmul.js';
import { createLoadVisualization } from './load.js';
import { createStoreVisualization } from './store.js';
import { createFlowDiagram } from './nki.js';
import { enableDrag } from './ui_helpers.js';

const DEFAULT_PALETTE = {
    blockBg: '#323232',
    blockHoverBg: '#4a4a4a',
    blockBorder: 'rgba(0, 0, 0, 0.5)',
    textPrimary: '#f8fafc',
    textSecondary: '#cbd5f5',
};

export class GridBlock {
    constructor(x, y, width, height, gridX, gridY, gridZ, blockData, onClose, containerElement, canvas, drawFunction, programIdConfig = null) {
        this.rect = { x, y, width, height };
        this.gridPosition = { x: gridX, y: gridY, z: gridZ };
        this.blockData = blockData;
        this.isHovered = false;
exec
/bin/bash -lc "sed -n '1,240p' triton_viz/templates/index.html" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triton Kernel Visualization</title>
    <link rel="stylesheet" href="/static/visualizer.css">
</head>
<body>
    <div class="viz-app">
        <aside id="control-panel">
            <div class="panel-header">
                <div class="title-block">
                    <span class="eyebrow">Triton Viz</span>
                    <h1>Kernel Explorer</h1>
                    <p class="control-note">Filter program IDs, move across slices, and jump into overview mode.</p>
                </div>
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                    <span id="theme-toggle-icon" aria-hidden="true">â˜€</span>
                </button>
exec
/bin/bash -lc "sed -n '1,260p' triton_viz/static/visualizer.css" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
:root {
    --dimension-line-opacity: 0.8;
    --dimension-text-size: 14px;
    --font-sans: 'Inter', 'Noto Sans SC', 'PingFang SC', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-mono: 'JetBrains Mono', 'Source Code Pro', 'Fira Code', monospace;
    --radius-xl: 28px;
    --radius-lg: 18px;
    --radius-md: 12px;
    --shadow-soft: 0 18px 60px rgba(15, 23, 42, 0.15);
    --transition-fast: 160ms ease;
    --sidebar-width: 820px;
    --sidebar-resizer-width: 8px;
}

:root,
:root[data-theme='light'] {
    --app-bg: #f5f7fb;
    --canvas-bg: #fbfcff;
    --grid-bg: #ffffff;
    --grid-border: rgba(15, 23, 42, 0.08);

thinking
**Continuing code exploration for gridblock**
exec
/bin/bash -lc "sed -n '260,620p' triton_viz/static/gridblock.js" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
        const { max } = this.programIdConfig;
        const nx = Math.max(0, Math.min(max.x, x));
        const ny = Math.max(0, Math.min(max.y, y));
        const nz = Math.max(0, Math.min(max.z, z));
        if (nx === this.gridPosition.x && ny === this.gridPosition.y && nz === this.gridPosition.z) return;
        this.gridPosition = { x: nx, y: ny, z: nz };
        this.programIdConfig.values = { x: nx, y: ny, z: nz };
        if (this.programIdConfig.getBlockData) {
            this.blockData = this.programIdConfig.getBlockData(nx, ny, nz);
        }
        if (this.titleEl) {
            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
        }
        if (this.badgeEl) {
            this.badgeEl.textContent = `${this.blockData.length} ops`;
        }
        if (this.headerBar && this.cardEl) {
            this.headerBar.remove();
            this.headerBar = this.createHeaderBar();
            this.cardEl.insertBefore(this.headerBar, this.contentArea);
exec
/bin/bash -lc "sed -n '240,620p' triton_viz/static/visualization.js" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
            const nextTheme = (document.documentElement.dataset.theme || 'light') === 'light' ? 'dark' : 'light';
            applyTheme(nextTheme);
        });
    }
}

function applyTheme(theme) {
    document.documentElement.dataset.theme = theme;
    localStorage.setItem(THEME_STORAGE_KEY, theme);
    const icon = document.getElementById('theme-toggle-icon');
    if (icon) {
        icon.textContent = theme === 'light' ? 'â˜€' : 'ðŸŒ™';
    }
    draw();
}

function setupControlEvents() {
    if (controls.resetBtn) {
        controls.resetBtn.addEventListener('click', () => {
            for (let i = 0; i < filterValues.length; i += 1) {
exec
/bin/bash -lc "sed -n '260,620p' triton_viz/static/visualizer.css" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
    background: rgba(148, 163, 184, 0.7);
    box-shadow: none;
}

.control-field input[type="range"]:disabled::-moz-range-track {
    background: rgba(148, 163, 184, 0.3);
}

.control-field input[type="range"]:disabled::-moz-range-thumb {
    background: rgba(148, 163, 184, 0.7);
    box-shadow: none;
}

.button-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
}

.viz-button {
exec
/bin/bash -lc "sed -n '620,1200p' triton_viz/static/visualization.js" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
    labels.forEach((label, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'control-field is-inline';
        const nameSpan = document.createElement('span');
        nameSpan.className = 'control-label';
        nameSpan.textContent = label;
        const valueSpan = document.createElement('span');
        valueSpan.className = 'value-pill';
        valueSpan.id = `pid-value-${index}`;
        const isLocked = maxValues[index] <= 0;
        if (isLocked) {
            filterValues[index] = 0;
        }
        const displayValue = isLocked ? 0 : Math.max(0, filterValues[index]);
        filterValues[index] = displayValue;
        valueSpan.textContent = String(displayValue);
        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = 0;
        slider.max = maxValues[index];

thinking
**Listing existing JS modules**

I'm checking other JavaScript modules in the static directory to understand their style and structure before creating the new op_workspace.js module.
exec
/bin/bash -lc 'ls triton_viz/static' in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
colormap.js
dimension_utils.js
gridblock.js
histogram.js
infoPopup.js
load.js
load_utils.js
matmul.js
nki.js
sbuf_panel.js
store.js
tensor_view.js
ui_helpers.js
visualization.js
visualizer.css
Reconnecting... 1/5 (stream disconnected before completion: Rate limit reached for gpt-5.2-codex in organization org-c0kECLeR35XJgKeB71QUU7E3 on tokens per min (TPM): Limit 500000, Used 488119, Requested 25042. Please try again in 1.579s. Visit https://platform.openai.com/account/rate-limits to learn more.)

thinking
**Checking style in existing modules**

I will review existing files like load.js to understand the code style conventions before implementing the new module.
exec
/bin/bash -lc "sed -n '1,160p' triton_viz/static/load.js" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
import { createTensorVisualization } from './tensor_view.js';
import * as THREE from 'https://esm.sh/three@0.155.0';

export function createLoadVisualization(containerElement, op, viewState = null) {
    return createTensorVisualization(containerElement, op, {
        type: 'Load',
        colors: {
            GLOBAL: new THREE.Color(0.2, 0.2, 0.2),
            HIGHLIGHT: new THREE.Color(0.0, 0.7, 1.0)
        },
        viewState
    });
}


thinking
**Planning grid UI removal and op workspace extraction**

I'm preparing to remove the grid overview UI by eliminating KernelGrid and extracting the op workspace logic from gridblock.js into a new module, likely op_workspace.js, which will decouple visualization and tabs from gridblock and possibly allow deleting or minimizing gridblock.js.
thinking
**Planning op workspace module and removing grid canvas**

I'll create a new op_workspace.js module as planned, possibly removing or minimizing gridblock.js, and update index.html by removing the grid overview canvas and related elements like the z-slider to fully eliminate grid UI components.
exec
/bin/bash -lc 'rg -n "z-slider|z-value|grid|canvas" triton_viz/templates/index.html triton_viz/static/visualizer.css triton_viz/static/visualization.js' in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
triton_viz/static/visualizer.css:18:    --canvas-bg: #fbfcff;
triton_viz/static/visualizer.css:19:    --grid-bg: #ffffff;
triton_viz/static/visualizer.css:20:    --grid-border: rgba(15, 23, 42, 0.08);
triton_viz/static/visualizer.css:39:    --canvas-bg: #0f172a;
triton_viz/static/visualizer.css:40:    --grid-bg: #111b34;
triton_viz/static/visualizer.css:41:    --grid-border: rgba(148, 163, 184, 0.25);
triton_viz/static/visualizer.css:77:    display: grid;
triton_viz/static/visualizer.css:78:    grid-template-columns: var(--sidebar-width) var(--sidebar-resizer-width) 1fr;
triton_viz/static/visualizer.css:84:body.tensor-only #canvas {
triton_viz/static/visualizer.css:202:    display: grid;
triton_viz/static/visualizer.css:203:    grid-template-columns: auto 1fr auto;
triton_viz/static/visualizer.css:273:.button-grid {
triton_viz/static/visualizer.css:274:    display: grid;
triton_viz/static/visualizer.css:275:    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
triton_viz/static/visualizer.css:351:#canvas-wrapper {
triton_viz/static/visualizer.css:353:    background: var(--canvas-bg);
triton_viz/static/visualizer.css:357:#canvas {
triton_viz/static/visualizer.css:379:    background: var(--canvas-bg);
triton_viz/static/visualizer.css:576:    background: var(--canvas-bg);
triton_viz/static/visualizer.css:744:        grid-template-columns: 1fr;

thinking
**Checking z-slider existence**

I don't find any z-slider element in the HTML, so now I'll search the codebase to see if it's defined elsewhere or dynamically created.
exec
/bin/bash -lc "rg -n \"z-slider|z-value\" -g'*' triton_viz" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
triton_viz/static/visualization.js:198:    controls.zSlider = document.getElementById('z-slider');
triton_viz/static/visualization.js:199:    controls.zValueLabel = document.getElementById('z-value');

thinking
**Preparing to update documentation**

I'm identifying references to the removed z-slider for removal and plan to update ARCHITECTURE.md and related docs to reflect this change. I'll open those files next for context.
exec
/bin/bash -lc "sed -n '1,220p' ARCHITECTURE.md" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 50ms:
# Architecture

## Front-end Annotation Layer
The front-end utilizes Three.js for 3D tensor visualization and a custom annotation layer for dimension lines and legends.

### CAD Dimension Overlays
Dimension lines are rendered as CAD-style annotations:
- **Extension Lines**: Perpendicular lines from tensor boundaries.
- **Dimension Lines**: Parallel lines showing the span.
- **Arrowheads**: Located at intersections, with automatic inside/outside placement logic.
- **Text Rendering**: High-quality vector text rendering using Multi-channel Signed Distance Fields (MSDF) via `Troika-Three-Text`, ensuring readability at all zoom levels without pixelation.
- **Logic**: Implemented in `triton_viz/static/dimension_utils.js`.

### Shape Legend
A floating DOM overlay that lists all active tensors and their shapes, color-coded to match the 3D meshes.
exec
/bin/bash -lc "sed -n '1,240p' MANUAL.md" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 50ms:
# Triton Viz User Manual

## Navigation and Controls
- **Orbit Controls**: Use mouse left-click to rotate, right-click to pan, and scroll to zoom.
- **Keyboard Shortcuts**:
  - `W/A/S/D`: Pan camera.
  - `Arrow Keys`: Tilt/Rotate camera.
  - `O/P`: Zoom out/in.

## Visual Annotations

### CAD-style Dimension Lines
Tensors in the visualization are annotated with CAD-style dimension lines to indicate their shapes.
- **Extension Lines**: Perpendicular lines at the start and end of each dimension.
- **Dimension Lines**: Parallel lines showing the span of the dimension.
- **Arrowheads**: Located at the intersection of dimension and extension lines.
- **Auto-offset Arrows**: If a dimension is too small to fit the arrows inside, they move to the outside, pointing inward.

### Color Coding
Dimension lines and numbers are color-coded to match the tensor they belong to.
exec
/bin/bash -lc "sed -n '1,200p' README.md" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
<a name="readme-top"></a>
# Triton-Viz: A Visualization Toolkit for programming with Triton
<!-- PROJECT LOGO -->
<br />
<div align="center">
    <img src="Logo.jpg" alt="Logo" width="320" height="320">
</div>
<br/>

Welcome to Triton-Viz, a visualization and profiling toolkit designed for deep learning applications. Built with the intention of making GPU programming on Triton more intuitive.

<!-- TABLE OF CONTENTS -->
<details>
  <summary>Table of Contents</summary>
  <ol>
    <li>
      <a href="#About">About</a>
    <li>
      <a href="#Getting-Started">Getting Started</a>
      <ul>
exec
/bin/bash -lc "sed -n '1,220p' triton_viz/ARCHITECTURE.md" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
# Triton-Viz Static Modules

- `load.js`: Handles load operation visualization.
- `store.js`: Handles store operation visualization.
- `matmul.js`: Handles matrix multiplication visualization.
- `dimension_utils.js`: Shared utilities for CAD-style dimensioning, legends, and high-quality vector text rendering.
- `load_utils.js`: General 3D scene and tensor setup helpers.


thinking
**Planning new op workspace module**

The plan defines removing the grid and canvas, replacing them with a reusable OpWorkspace that manages the active program's ops and UI, reusing GridBlock detail view logic but without grid specifics. It also includes adding console.info logs for program coord changes and op tab switches. Next, I'll implement this new workspace handling and integrate it with visualization.js and program ID sliders.
thinking
**Detailing workspace UI and state integration**

I've outlined removing canvas and grid-related code while reusing GridBlockâ€™s detailed view UI and CSS with minimal changes, including dropping fixed overlays where possible but keeping styles for consistency. The new workspace will manage program coordinates, update sliders, and log interactions, ensuring default program opens at (0,0,0) and sidebar controls remain fully visible without toggling detail-open. Next, I'll implement the rendering inside visualization-container and hook slider inputs to update the active program accordingly.
exec
/bin/bash -lc 'rg -n "setOpControlHandlers|setOpControlState|opControls" triton_viz/static' in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
triton_viz/static/visualization.js:39:const opControls = {
triton_viz/static/visualization.js:49:function setOpControlState(nextState = {}) {
triton_viz/static/visualization.js:50:    opControls.state = {
triton_viz/static/visualization.js:51:        ...opControls.state,
triton_viz/static/visualization.js:54:    try { window.__tritonVizOpState = { ...opControls.state }; } catch (err) {}
triton_viz/static/visualization.js:58:function setOpControlHandlers(handlers = null) {
triton_viz/static/visualization.js:59:    opControls.handlers = handlers;
triton_viz/static/visualization.js:64:    opControls.handlers = null;
triton_viz/static/visualization.js:65:    opControls.state = {
triton_viz/static/visualization.js:71:    try { window.__tritonVizOpState = { ...opControls.state }; } catch (err) {}
triton_viz/static/visualization.js:85:    const { handlers, state } = opControls;
triton_viz/static/visualization.js:103:            setOpControlState({ [key]: !!value });
triton_viz/static/visualization.js:106:        setOpControlState({ [key]: !!result });
triton_viz/static/visualization.js:111:    window.setOpControlHandlers = setOpControlHandlers;
triton_viz/static/visualization.js:112:    window.setOpControlState = setOpControlState;
triton_viz/static/visualization.js:301:            const handler = opControls.handlers?.toggleColorize;
triton_viz/static/visualization.js:309:            const handler = opControls.handlers?.toggleHistogram;
triton_viz/static/visualization.js:317:            const handler = opControls.handlers?.toggleAllPrograms;
triton_viz/static/tensor_view.js:778:            if (window.setOpControlState) {
triton_viz/static/tensor_view.js:779:                window.setOpControlState({

thinking
**Checking op control handlers in tensor view**

I'm investigating how tensor_view sets op control handlers like window.setOpControlHandlers and whether these are configured when ops are visualized, possibly in showDetailedView or during gridblock's tensor visualization creation.
exec
/bin/bash -lc "sed -n '880,980p' triton_viz/static/tensor_view.js" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
        });
        const items = getValueLegendItems();
        items.push(createProgramSubsetLegendItem(getBaseCountColor(), state.programSubsets.subsets, state.programSubsetHues));
        createLegends(items);
    };
    const applyProgramPayload = (payload) => {
        const subsets = normalizeProgramSubsets(payload);
        if (subsets.subsetCount > PROGRAM_SUBSET_LIMIT) {
            state.allProgramsMode = 'count';
            state.programCounts = normalizeProgramCounts(payload);
            state.programSubsets = null;
            state.programSubsetHues = null;
        } else {
            state.allProgramsMode = 'subset';
            state.programSubsets = subsets;
            state.programSubsetHues = buildSubsetHues(subsets.subsets);
            state.programCounts = null;
        }
    };
    const ensureProgramData = async () => {


thinking
**Designing new workspace module**

Planning to isolate GridBlock's detailed view into a new `OpWorkspace` class in its own file, replacing KernelGrid and removing canvas references; considering constructor parameters and state management between visualization.js and the new module.
thinking
**Defining workspace class structure**

Drafted `OpWorkspace` class with state, initialization, and program update logic including program coordinate clamping, block data retrieval, UI updates, and logging of program and tab changes; planning to preserve global code toggle and window state variables for compatibility with existing code panels and op controls.
exec
/bin/bash -lc "rg -n \"__tritonVizActiveBlock\" -g'*' triton_viz/static" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
triton_viz/static/gridblock.js:104:            window.__tritonVizActiveBlock = this;
triton_viz/static/gridblock.js:134:            const activeBlock = window.__tritonVizActiveBlock;
triton_viz/static/gridblock.js:465:            if (window.__tritonVizActiveBlock === this) {
triton_viz/static/gridblock.js:466:                window.__tritonVizActiveBlock = null;


thinking
**Planning op workspace integration**

I'm deciding to replicate gridblockâ€™s structure in op_workspace with a similar `blockData` and setting `window.__tritonVizActiveBlock` for compatibility. I need to ensure op controls reset appropriately when switching programs or when no ops exist, likely calling `resetOpControls` to clear or disable controls.
thinking
**Refining op visualization cleanup and UI updates**

I'll ensure `resetOpControls` is called to disable controls when no ops exist and remove unused grid-specific UI classes and canvas logic. The visualization.js will be simplified by removing canvas and grid code but retaining op controls and sidebar resizing with a resize event dispatched to update 3D scenes.
exec
/bin/bash -lc "rg -n \"addEventListener\\('resize'\" triton_viz/static" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
triton_viz/static/visualization.js:224:    window.addEventListener('resize', resizeCanvas);

thinking
**Searching for window resize handlers**

I'm checking tensor_view for any own resize logic by searching for window.onresize handlers.
exec
/bin/bash -lc 'rg -n "resize" triton_viz/static/tensor_view.js' in /home/trtx/College/keren/triton-viz/cr-frontend-1 exited 1 in 51ms:


thinking
**Verifying resize handling in 3D view**

I'm checking if the 3D view resizing is managed via ResizeObserver or another method inside the tensor_view code to understand how resizing is triggered or handled.
exec
/bin/bash -lc 'rg -n "ResizeObserver|resize" triton_viz/static/tensor_view.js' in /home/trtx/College/keren/triton-viz/cr-frontend-1 exited 1 in 51ms:



thinking
**Considering resizing strategy for 3D canvas**

The 3D canvas likely sets its size once on initialization using container dimensions and lacks listeners for dynamic resizing, so adding a ResizeObserver or resize event handling on the container might be needed to ensure proper updates when the main area or sidebar resizes.
thinking
**Deciding minimal resize updates and gridblock removal**

Resizer currently only triggers grid canvas resizing, not op views; since op views lack resize handlers and given minimal change goals, skipping new resize hooks is acceptable. For gridblock, it's unused outside visualization.js, so removing the file aligns with instructions to eliminate grid overview UI and duplicate logic.
exec
/bin/bash -lc "rg -n \"GridBlock\" -g'*.js' triton_viz/static" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
triton_viz/static/visualization.js:1:import { GridBlock } from './gridblock.js';
triton_viz/static/visualization.js:485:                const block = new GridBlock(
triton_viz/static/gridblock.js:15:export class GridBlock {


thinking
**Deciding how to handle gridblock file**

The plan calls for extracting op workspace logic from the gridblock file into a new module without explicitly deleting the original. I'll focus on moving that logic out for clarity while keeping or minimally changing the gridblock file to avoid duplication and maintain minimal disruption.
thinking
**Planning comprehensive refactor for op workspace extraction**

I'll create a new op_workspace.js by moving the relevant class from gridblock.js, then delete gridblock.js entirely since grid overview is removed. visualization.js will be simplified to use the new op workspace module, removing all canvas and grid logic. CSS and UI elements tied to canvas will be cleaned or adjusted for interactivity. I'll redesign program filtering and controls to sync with op workspace, ensuring state updates and logging while preserving view state on program switches.
exec
/bin/bash -lc "rg -n \"current_op_uuid\" -g'*.js' triton_viz/static" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 50ms:
triton_viz/static/gridblock.js:135:            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
triton_viz/static/tensor_view.js:842:    window.current_op_uuid = op.uuid;


thinking
**Designing updated layout and CSS structure**

I'm refining the DOM and CSS so the canvas wrapper is relative positioned with full-area filling visualization container using flex layout, and planning to replace the fixed-position detail-overlay with a new relative-positioned op-workspace class for better workspace integration.
thinking
**Planning to repurpose overlay class and update docs**

I'm deciding to repurpose `.detail-overlay` as a full absolute-positioned container inside relative `#canvas-wrapper` to avoid JS changes, adjusting its CSS to remove sidebar offsets, and preparing to update architecture and manual docs with new active program workspace details while removing obsolete grid references.
exec
/bin/bash -lc 'rg -n "show code|Show Code|show-code" triton_viz/static' in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
triton_viz/static/visualizer.css:524:.show-code-btn {
triton_viz/static/visualizer.css:540:.show-code-panel {
triton_viz/static/visualizer.css:558:.show-code-panel.is-sidebar {
triton_viz/static/visualizer.css:569:.show-code-panel.is-sidebar pre {
triton_viz/static/visualizer.css:574:.show-code-panel pre {
triton_viz/static/visualizer.css:585:.show-code-panel .panel-header {
triton_viz/static/gridblock.js:141:            wrapper.className = 'show-code-panel';

thinking
**Investigating code panel toggle**

I'm checking how only gridblock sets show the code panel and searching for "show-code-btn" in JS to find where it's created or controlled, noting `createFloatingBar` in tensor_view might be involved.
exec
/bin/bash -lc 'rg -n "show-code" triton_viz/static/tensor_view.js' in /home/trtx/College/keren/triton-viz/cr-frontend-1 exited 1 in 51ms:




thinking
**Clarifying code peek and UI updates**

The code peek toggle might rely on a global or a different control, so adding a show code button is deferred. The focus is on removing the grid overview UI elements and ensuring program ID sliders update the active program even without data by parsing visualization_data keys carefully, reusing existing parsing utilities and maintaining key handlers in visualization.js.
thinking
**Designing new op_workspace module and removal plan**

The plan is to create an `OpWorkspace` class derived from GridBlock's detail view code but without grid specifics, handling initialization, program changes, and UI updates with logging. After implementing it, visualization.js will switch to use this module, the old grid drawing and file removed, and related UI and docs updated accordingly.
thinking
**Implementing UI integration and program ID logic**

The plan sets up `OpWorkspace` with max values and block data access, updates program ID sliders with clamping and syncing, removes legacy canvas and theme-draw calls, adjusts UI text, and ensures proper handling of empty data and controls. Key methods for getting block data by coordinate with flexible key formats are defined before moving on to file changes including creating the new module.
file update
A /home/trtx/College/keren/triton-viz/cr-frontend-1/triton_viz/static/op_workspace.js
import { createMatMulVisualization } from './matmul.js';
import { createLoadVisualization } from './load.js';
import { createStoreVisualization } from './store.js';
import { createFlowDiagram } from './nki.js';
import { enableDrag } from './ui_helpers.js';

export class OpWorkspace {
    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
        this.containerElement = containerElement;
        this.getBlockData = getBlockData;
        this.maxValues = maxValues;
        this.gridPosition = { x: 0, y: 0, z: 0 };
        this.blockData = [];
        this.visualizationContainer = null;
        this.visualizationCleanupFunction = null;
        this.contentArea = null;
        this.activeTab = null;
        this.activeTabIndex = 0;
        this.lastOpType = null;
        this.titleEl = null;
        this.badgeEl = null;
        this.cardEl = null;
        this.headerBar = null;
        this.initialize();
    }

    initialize() {
        if (!this.containerElement) return;
        this.visualizationContainer = this.createVisualizationContainer();
        const card = document.createElement('div');
        card.className = 'detail-card';
        this.cardEl = card;

        const titleRow = this.createTitleRow();
        this.headerBar = this.createHeaderBar();
        this.contentArea = this.createContentArea();

        card.appendChild(titleRow);
        card.appendChild(this.headerBar);
        card.appendChild(this.contentArea);
        this.visualizationContainer.appendChild(card);

        this.containerElement.innerHTML = '';
        this.containerElement.appendChild(this.visualizationContainer);
        this.containerElement.style.display = 'block';
        this.containerElement.style.pointerEvents = 'auto';

        this.ensureGlobalCodeToggle();
        try {
            window.__tritonVizActiveBlock = this;
        } catch (error) {}
    }

    setProgram(x, y, z, { force = false } = {}) {
        const max = this.maxValues || { x: 0, y: 0, z: 0 };
        const nx = Math.max(0, Math.min(max.x ?? 0, x));
        const ny = Math.max(0, Math.min(max.y ?? 0, y));
        const nz = Math.max(0, Math.min(max.z ?? 0, z));
        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
        if (!changed && !force) return;
        this.gridPosition = { x: nx, y: ny, z: nz };
        if (this.getBlockData) {
            this.blockData = this.getBlockData(nx, ny, nz);
        } else {
            this.blockData = [];
        }
        if (changed) {
            console.info('Active program changed', { x: nx, y: ny, z: nz });
            if (window.resetOpControls) window.resetOpControls();
        }
        if (this.titleEl) {
            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
        }
        if (this.badgeEl) {
            this.badgeEl.textContent = `${this.blockData.length} ops`;
        }
        if (this.headerBar && this.cardEl) {
            this.headerBar.remove();
            this.headerBar = this.createHeaderBar();
            this.cardEl.insertBefore(this.headerBar, this.contentArea);
        }
        if (this.blockData.length > 0) {
            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
            this.activeTabIndex = nextIndex;
            this.displayOpVisualization(this.blockData[nextIndex], {
                refreshCodePanel: false,
                preserveViewState: true,
                logTabChange: true,
            });
        } else {
            this.renderEmptyState();
        }
    }

    createVisualizationContainer() {
        const container = document.createElement('div');
        container.className = 'detail-overlay';
        return container;
    }

    createTitleRow() {
        const row = document.createElement('div');
        row.className = 'overlay-title-row';
        const title = document.createElement('h2');
        title.className = 'detail-title';
        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = `${this.blockData.length} ops`;
        row.appendChild(title);
        row.appendChild(badge);
        this.titleEl = title;
        this.badgeEl = badge;
        return row;
    }

    createHeaderBar() {
        const headerBar = document.createElement('div');
        headerBar.className = 'detail-tabs';
        this.activeTab = null;

        let defaultTab = null;
        let preferredTab = null;
        this.blockData.forEach((op, index) => {
            const opTab = this.createOperationTab(op);
            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
            headerBar.appendChild(opTab);
            if (index === 0) {
                defaultTab = opTab;
            }
            if (this.activeTabIndex === index) {
                preferredTab = opTab;
            }
        });
        if (preferredTab) {
            this.setActiveTab(preferredTab);
        } else if (defaultTab) {
            this.setActiveTab(defaultTab);
        }

        const flowTab = this.createTabButton('Flow');
        flowTab.addEventListener('click', () => {
            this.setActiveTab(flowTab);
            this.displayFlowDiagram({ logTabChange: true });
        });
        headerBar.appendChild(flowTab);

        return headerBar;
    }

    createOperationTab(op) {
        const pieces = [
            op.type,
            (op.global_shape || []).join('Ã—'),
            typeof op.overall_key === 'string' ? op.overall_key : ''
        ].filter(Boolean);
        const tab = this.createTabButton(pieces.join(' â€¢ '));
        return tab;
    }

    createTabButton(label) {
        const btn = document.createElement('button');
        btn.className = 'detail-tab';
        btn.textContent = label;
        return btn;
    }

    setActiveTab(tab) {
        if (this.activeTab === tab) return;
        if (this.activeTab) {
            this.activeTab.classList.remove('is-active');
        }
        this.activeTab = tab;
        if (this.activeTab) {
            this.activeTab.classList.add('is-active');
        }
    }

    handleTabClick(clickedTab, op, index = null) {
        this.setActiveTab(clickedTab);
        if (typeof index === 'number') {
            this.activeTabIndex = index;
        }
        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
    }

    createContentArea() {
        const contentArea = document.createElement('div');
        contentArea.className = 'detail-content';
        if (this.blockData.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'overall-empty';
            empty.textContent = 'No operation data available.';
            contentArea.appendChild(empty);
        }
        return contentArea;
    }

    renderEmptyState() {
        if (!this.contentArea) return;
        this.contentArea.innerHTML = '';
        const empty = document.createElement('div');
        empty.className = 'overall-empty';
        empty.textContent = 'No operation data available.';
        this.contentArea.appendChild(empty);
        if (window.resetOpControls) window.resetOpControls();
    }

    logTabChange(opType) {
        console.info('Op tab changed', {
            program: {
                x: this.gridPosition.x,
                y: this.gridPosition.y,
                z: this.gridPosition.z,
            },
            opType,
        });
    }

    displayOpVisualization(op, options = {}) {
        if (!this.contentArea) {
            console.error('Content area is not initialized');
            return;
        }
        let viewState = options.viewState || null;
        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
        if (!viewState && canReuseViz) {
            viewState = this.contentArea.__vizGetState();
        }
        const preserveCodePanel = options.refreshCodePanel === false;
        if (preserveCodePanel) {
            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
        }
        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
        try {
            if (!reuseTensorView && this.visualizationCleanupFunction) {
                this.visualizationCleanupFunction();
                this.visualizationCleanupFunction = null;
            }
        } finally {
            if (preserveCodePanel) {
                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
            }
        }
        if (!reuseTensorView) {
            this.contentArea.innerHTML = '';
        }
        try {
            window.last_op = op;
            window.last_op_global_shape = op.global_shape;
            window.last_global_coords = op.global_coords;
            window.last_slice_shape = op.slice_shape;
            window.last_slice_coords = op.slice_coords;
        } catch (error) { /* noop */ }

        switch (op.type) {
            case 'Dot':
                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
                break;
            case 'Load':
                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
                break;
            case 'Store':
                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
                break;
            default:
                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
        }
        this.lastOpType = op.type;
        if (options.logTabChange) {
            this.logTabChange(op.type);
        }
        if (options.refreshCodePanel !== false) {
            this.syncCodePanel(true);
        }
    }

    displayFlowDiagram({ logTabChange = false } = {}) {
        if (!this.contentArea) return;
        if (this.visualizationCleanupFunction) {
            this.visualizationCleanupFunction();
            this.visualizationCleanupFunction = null;
        }
        this.contentArea.innerHTML = '';
        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
        if (logTabChange) {
            this.logTabChange('Flow');
        }
    }

    ensureGlobalCodeToggle() {
        if (window.__tritonVizCodeToggle) return;
        let panel = null;
        let visible = false;

        const destroyPanel = () => {
            if (panel && panel.remove) panel.remove();
            const host = document.getElementById('op-code-panel');
            if (host && host.contains(panel)) {
                host.innerHTML = '';
            }
            panel = null;
        };

        const getActiveUuid = () => {
            const activeBlock = window.__tritonVizActiveBlock;
            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
        };

        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
            destroyPanel();
            const wrapper = document.createElement('div');
            wrapper.className = 'show-code-panel';
            const header = document.createElement('div');
            header.className = 'panel-header drag-handle';
            header.style.fontWeight = '600';
            header.style.marginBottom = '8px';
            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
            wrapper.appendChild(header);
            const blurb = document.createElement('div');
            blurb.style.fontSize = '12px';
            blurb.style.color = 'var(--text-secondary)';
            blurb.style.marginBottom = '8px';
            blurb.textContent = 'Arrow points to the line being visualized.';
            wrapper.appendChild(blurb);
            try {
                const API_BASE = window.__TRITON_VIZ_API__ || '';
                const res = await fetch(`${API_BASE}/api/op_code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
                });
                const data = await res.json();
                const meta = document.createElement('div');
                meta.style.marginBottom = '6px';
                meta.style.fontSize = '12px';
                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
                wrapper.appendChild(meta);
                const pre = document.createElement('pre');
                pre.style.margin = '0';
                const lines = (data.lines || []).map((line) => {
                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
                }).join('\n');
                pre.textContent = lines || '(no code available)';
                wrapper.appendChild(pre);
            } catch (error) {
                const err = document.createElement('div');
                err.textContent = 'Failed to load code context.';
                wrapper.appendChild(err);
            }
            const host = document.getElementById('op-code-panel');
            if (host) {
                host.innerHTML = '';
                wrapper.classList.add('is-sidebar');
                host.appendChild(wrapper);
            } else {
                document.body.appendChild(wrapper);
                enableDrag(wrapper, { handle: header, bounds: window });
            }
            panel = wrapper;
        };

        const togglePanel = async (force) => {
            const next = typeof force === 'boolean' ? force : !visible;
            if (!next) {
                visible = false;
                destroyPanel();
                return visible;
            }
            const activeUuid = getActiveUuid();
            if (!activeUuid) {
                visible = false;
                destroyPanel();
                return visible;
            }
            visible = true;
            await createPanel(activeUuid, 0, 8);
            return visible;
        };

        const hidePanel = () => {
            visible = false;
            destroyPanel();
            return visible;
        };

        window.__tritonVizCodeToggle = togglePanel;
        window.__tritonVizCodeHide = hidePanel;
        window.__tritonVizCodeVisible = () => visible;
    }

    syncCodePanel(forceShow = false) {
        if (!window.__tritonVizCodeToggle) return;
        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
        if (!forceShow && !isVisible) return;
        const result = window.__tritonVizCodeToggle(true);
        if (!window.setOpControlState) return;
        if (result && typeof result.then === 'function') {
            result.then((visible) => {
                window.setOpControlState({ showCode: !!visible });
            });
        } else {
            window.setOpControlState({ showCode: !!result });
        }
    }
}
apply_patch(auto_approved=true) exited 0 in 2ms:
Success. Updated the following files:
A /home/trtx/College/keren/triton-viz/cr-frontend-1/triton_viz/static/op_workspace.js
file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}

file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}



thinking
**Planning large visualization rewrite**

I'm deciding to fully rewrite visualization.js rather than patch it due to its size, preparing new content that imports OpWorkspace and simplifies previous grid code while keeping only necessary controls.
thinking
**Refining control handling and initialization**

I'm confirming which controls and functions to keep or remove for a cleaner visualization.js, streamlining event setups, removing unused UI elements like infoBtn, and revising initialization functions to reflect these changes without breaking existing behavior.
exec
/bin/bash -lc "cat <<'EOF' > /home/trtx/College/keren/triton-viz/cr-frontend-1/triton_viz/static/visualization.js
import { OpWorkspace } from './op_workspace.js';

let globalData;
let visualizationData;
let containerElement;
let opWorkspace;
let maxX = 0;
let maxY = 0;
let maxZ = 0;
const filterValues = [0, 0, 0];
const THEME_STORAGE_KEY = 'triton-viz-theme';

const controls = {
    panel: null,
    pidContainer: null,
    resetBtn: null,
    precomputeBtn: null,
    infoBtn: null,
    themeToggle: null,
    resizer: null,
    opColorizeBtn: null,
    opHistogramBtn: null,
    opAllProgramsBtn: null,
};

let controlToastEl = null;
let controlToastTimer = null;

const opControls = {
    handlers: null,
    state: {
        colorize: false,
        showCode: false,
        histogram: false,
        allPrograms: false,
    },
};

function setOpControlState(nextState = {}) {
    opControls.state = {
        ...opControls.state,
        ...nextState,
    };
    try { window.__tritonVizOpState = { ...opControls.state }; } catch (err) {}
    updateOpControls();
}

function setOpControlHandlers(handlers = null) {
    opControls.handlers = handlers;
    updateOpControls();
}

function resetOpControls() {
    opControls.handlers = null;
    opControls.state = {
        colorize: false,
        showCode: false,
        histogram: false,
        allPrograms: false,
    };
    try { window.__tritonVizOpState = { ...opControls.state }; } catch (err) {}
    if (window.__tritonVizCodeHide) {
        window.__tritonVizCodeHide();
    }
    updateOpControls();
}

function updateToggleLabel(button, label, isOn) {
    if ("'!button) return;
    button.textContent = `${label}: ${isOn ? '"'ON' : 'OFF'}"'`;
    button.classList.toggle('"'active', isOn);
}

function updateOpControls() {
    const { handlers, state } = opControls;
    if (controls.opColorizeBtn) {
        controls.opColorizeBtn.disabled = "'!handlers || !handlers.toggleColorize;
        updateToggleLabel(controls.opColorizeBtn, '"'Heatmap', "'!!state.colorize);
    }
    if (controls.opHistogramBtn) {
        controls.opHistogramBtn.disabled = !handlers || !handlers.toggleHistogram;
        updateToggleLabel(controls.opHistogramBtn, '"'Value Histogram', "'!!state.histogram);
    }
    if (controls.opAllProgramsBtn) {
        controls.opAllProgramsBtn.disabled = !handlers || !handlers.toggleAllPrograms;
        updateToggleLabel(controls.opAllProgramsBtn, '"'All Program IDs', "'!!state.allPrograms);
    }
}

function applyToggleResult(result, key) {
    if (result && typeof result.then === '"'function') {
        result.then((value) => {
            setOpControlState({ [key]: "'!!value });
        });
    } else {
        setOpControlState({ [key]: !!result });
    }
}

try {
    window.setOpControlHandlers = setOpControlHandlers;
    window.setOpControlState = setOpControlState;
    window.resetOpControls = resetOpControls;
} catch (err) {
    console.warn('"'Unable to expose op control helpers', err);
}

function initializeApp() {
    containerElement = document.getElementById('visualization-container');
    controls.panel = document.getElementById('control-panel');
    controls.resizer = document.getElementById('sidebar-resizer');
    controls.pidContainer = document.getElementById('pid-controls');
    controls.resetBtn = document.getElementById('reset-filters');
    controls.precomputeBtn = document.getElementById('btn-precompute');
    controls.themeToggle = document.getElementById('theme-toggle');
    controls.opColorizeBtn = document.getElementById('btn-op-colorize');
    controls.opHistogramBtn = document.getElementById('btn-op-histogram');
    controls.opAllProgramsBtn = document.getElementById('btn-op-all-programs');

    if ("'!containerElement) {
        console.error('"'Essential visualization elements are missing.');
        return;
    }

    setupThemeToggle();
    setupControlEvents();
    setupSidebarResizer();
    updateOpControls();
    fetchData();
}

function setupThemeToggle() {
    const stored = localStorage.getItem(THEME_STORAGE_KEY);
    const defaultTheme = stored || document.documentElement.dataset.theme || 'light';
    applyTheme(defaultTheme);
    if (controls.themeToggle) {
        controls.themeToggle.addEventListener('click', () => {
            const nextTheme = (document.documentElement.dataset.theme || 'light') === 'light' ? 'dark' : 'light';
            applyTheme(nextTheme);
        });
    }
}

function applyTheme(theme) {
    document.documentElement.dataset.theme = theme;
    localStorage.setItem(THEME_STORAGE_KEY, theme);
    const icon = document.getElementById('theme-toggle-icon');
    if (icon) {
        icon.textContent = theme === 'light' ? 'â˜€' : 'ðŸŒ™';
    }
}

function setupControlEvents() {
    if (controls.resetBtn) {
        controls.resetBtn.addEventListener('click', () => {
            setActiveProgram(0, 0, 0, { syncControls: true, force: true });
            showControlToast('Filters reset');
        });
    }

    if (controls.precomputeBtn) {
        controls.precomputeBtn.addEventListener('click', () => {
            showControlToast('Precompute mode is coming soon. This build previews the layout.');
        });
    }

    if (controls.opColorizeBtn) {
        controls.opColorizeBtn.addEventListener('click', () => {
            const handler = opControls.handlers?.toggleColorize;
            if ("'!handler) return;
            applyToggleResult(handler(), '"'colorize');
        });
    }

    if (controls.opHistogramBtn) {
        controls.opHistogramBtn.addEventListener('click', () => {
            const handler = opControls.handlers?.toggleHistogram;
            if ("'!handler) return;
            applyToggleResult(handler(), '"'histogram');
        });
    }

    if (controls.opAllProgramsBtn) {
        controls.opAllProgramsBtn.addEventListener('click', () => {
            const handler = opControls.handlers?.toggleAllPrograms;
            if ("'!handler) return;
            applyToggleResult(handler(), '"'allPrograms');
        });
    }
}

function setupSidebarResizer() {
    if ("'!controls.resizer || !controls.panel) return;
    const root = document.documentElement;
    const minWidth = 0;
    let startX = 0;
    let startWidth = 0;

    const onPointerMove = (event) => {
        const delta = event.clientX - startX;
        const resizerWidth = controls.resizer.getBoundingClientRect().width || 0;
        const maxWidth = Math.max(0, window.innerWidth - resizerWidth);
        const next = Math.min(maxWidth, Math.max(minWidth, startWidth + delta));
        root.style.setProperty('"'--sidebar-width', "'`${next}px`);
    };

    const onPointerUp = (event) => {
        controls.resizer.releasePointerCapture(event.pointerId);
        window.removeEventListener('"'pointermove', onPointerMove);
        window.removeEventListener('pointerup', onPointerUp);
    };

    controls.resizer.addEventListener('pointerdown', (event) => {
        startX = event.clientX;
        startWidth = controls.panel.getBoundingClientRect().width;
        controls.resizer.setPointerCapture(event.pointerId);
        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);
    });
}

function showControlToast(message) {
    if ("'!controls.panel) {
        console.info(message);
        return;
    }
    if (!controlToastEl) {
        controlToastEl = document.createElement('"'div');
        controlToastEl.id = 'control-panel-toast';
        controlToastEl.className = 'info-card';
        controls.panel.appendChild(controlToastEl);
    }
    controlToastEl.textContent = message;
    controlToastEl.style.opacity = '1';
    clearTimeout(controlToastTimer);
    controlToastTimer = setTimeout(() => {
        if (controlToastEl) {
            controlToastEl.style.opacity = '0';
        }
    }, 3200);
}

function determineMaxValues(opsData) {
    maxX = 0;
    maxY = 0;
    maxZ = 0;
    Object.keys(opsData || {}).forEach((key) => {
        const [x, y, z] = key
            .replace(/[()]/g, '')
            .split(',')
            .map((s) => Number(String(s).trim()));
        if (Number.isFinite(x)) maxX = Math.max(maxX, x);
        if (Number.isFinite(y)) maxY = Math.max(maxY, y);
        if (Number.isFinite(z)) maxZ = Math.max(maxZ, z);
    });
}

function getBlockDataAt(nx, ny, nz) {
    if ("'!visualizationData) return [];
    const withSpaces = `(${nx}, ${ny}, ${nz})`;
    const withoutSpaces = `(${nx},${ny},${nz})`;
    return (
        visualizationData[withSpaces] ||
        visualizationData[withoutSpaces] ||
        []
    );
}

function syncProgramControls() {
    for (let i = 0; i < filterValues.length; i += 1) {
        const slider = document.querySelector(`input[data-filter-index="${i}"]`);
        if (slider) {
            slider.value = filterValues[i];
        }
        const valuePill = document.getElementById(`pid-value-${i}`);
        if (valuePill) valuePill.textContent = String(filterValues[i]);
    }
}

function setActiveProgram(x, y, z, { syncControls = false, force = false } = {}) {
    const nextX = Math.max(0, Math.min(maxX, x));
    const nextY = Math.max(0, Math.min(maxY, y));
    const nextZ = Math.max(0, Math.min(maxZ, z));
    filterValues[0] = nextX;
    filterValues[1] = nextY;
    filterValues[2] = nextZ;
    if (syncControls) {
        syncProgramControls();
    }
    if (opWorkspace) {
        opWorkspace.setProgram(nextX, nextY, nextZ, { force });
    }
}

function createProgramIdControls() {
    if (!controls.pidContainer) return;
    controls.pidContainer.innerHTML = '"'';
    const labels = ['X', 'Y', 'Z'];
    const maxValues = [maxX, maxY, maxZ];
    labels.forEach((label, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'control-field is-inline';
        const nameSpan = document.createElement('span');
        nameSpan.className = 'control-label';
        nameSpan.textContent = label;
        const valueSpan = document.createElement('span');
        valueSpan.className = 'value-pill';
        valueSpan.id = "'`pid-value-${index}`;
        const isLocked = maxValues[index] <= 0;
        if (isLocked) {
            filterValues[index] = 0;
        }
        const displayValue = isLocked ? 0 : Math.max(0, filterValues[index]);
        filterValues[index] = displayValue;
        valueSpan.textContent = String(displayValue);
        const slider = document.createElement('"'input');
        slider.type = 'range';
        slider.min = 0;
        slider.max = maxValues[index];
        slider.value = displayValue;
        slider.dataset.filterIndex = index;
        slider.disabled = isLocked;
        const tickId = "'`pid-ticks-${index}`;
        const ticks = document.createElement('"'datalist');
        ticks.id = tickId;
        for (let i = 0; i <= maxValues[index]; i += 1) {
            const opt = document.createElement('option');
            opt.value = String(i);
            ticks.appendChild(opt);
        }
        slider.setAttribute('list', tickId);
        slider.addEventListener('input', handleProgramFilterChange);
        wrapper.appendChild(nameSpan);
        wrapper.appendChild(slider);
        wrapper.appendChild(valueSpan);
        wrapper.appendChild(ticks);
        controls.pidContainer.appendChild(wrapper);
    });
}

function handleProgramFilterChange(event) {
    const index = Number(event.target.dataset.filterIndex);
    const value = Number(event.target.value);
    filterValues[index] = value;
    setActiveProgram(filterValues[0], filterValues[1], filterValues[2], { syncControls: true });
}

function initializeUIElements() {
    if ("'!globalData || !globalData.ops) return;
    visualizationData = globalData.ops.visualization_data || {};
    opWorkspace = new OpWorkspace(containerElement, {
        getBlockData: getBlockDataAt,
        maxValues: { x: maxX, y: maxY, z: maxZ },
    });
    createProgramIdControls();
    setActiveProgram(0, 0, 0, { syncControls: true, force: true });
}

async function fetchData() {
    try {
        const API_BASE = window.__TRITON_VIZ_API__ || '"'';
        const response = await fetch("'`${API_BASE}/api/data`);
        globalData = await response.json();
        determineMaxValues(globalData?.ops?.visualization_data || {});
        initializeUIElements();
    } catch (error) {
        console.error('"'Error fetching data:', error);
        showControlToast('Failed to load data. Please ensure the backend is running.');
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    initializeApp();
}
EOF" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:

file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}


thinking
**Updating index.html to remove canvas and update text**
file update
M /home/trtx/College/keren/triton-viz/cr-frontend-1/triton_viz/templates/index.html
@@ -15,3 +15,3 @@
                     <h1>Kernel Explorer</h1>
-                    <p class="control-note">Filter program IDs, move across slices, and jump into overview mode.</p>
+                    <p class="control-note">Filter program IDs and explore the active program workspace.</p>
                 </div>
@@ -40,3 +40,3 @@
                 </div>
-                <p class="control-note">Open a block to enable operation controls.</p>
+                <p class="control-note">Operation controls follow the active program selection.</p>
             </section>
@@ -48,3 +48,3 @@
                 <p class="control-note">
-                    Open the detailed view of any block to use the Show Code toggle for source context.
+                    Use the code panel to view source context for the active operation.
                 </p>
@@ -56,3 +56,2 @@
         <main id="canvas-wrapper">
-            <canvas id="canvas" aria-label="Kernel Visualization Canvas"></canvas>
             <div id="visualization-container"></div>
apply_patch(auto_approved=true) exited 0 in 4ms:
Success. Updated the following files:
M /home/trtx/College/keren/triton-viz/cr-frontend-1/triton_viz/templates/index.html
file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}
diff --git a/triton_viz/templates/index.html b/triton_viz/templates/index.html
index 4b4b4edb219e7846c77e4c734030087ecb31f6aa..8197842b0f2d159ac3c34fb43c154443556d8e29
--- a/triton_viz/templates/index.html
+++ b/triton_viz/templates/index.html
@@ -13,7 +13,7 @@
                 <div class="title-block">
                     <span class="eyebrow">Triton Viz</span>
                     <h1>Kernel Explorer</h1>
-                    <p class="control-note">Filter program IDs, move across slices, and jump into overview mode.</p>
+                    <p class="control-note">Filter program IDs and explore the active program workspace.</p>
                 </div>
                 <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                     <span id="theme-toggle-icon" aria-hidden="true">â˜€</span>
@@ -38,7 +38,7 @@
                     <button id="btn-op-all-programs" class="viz-button ghost" type="button" disabled>All Program IDs: OFF</button>
                     <button id="btn-op-histogram" class="viz-button ghost" type="button" disabled>Value Histogram</button>
                 </div>
-                <p class="control-note">Open a block to enable operation controls.</p>
+                <p class="control-note">Operation controls follow the active program selection.</p>
             </section>
 
             <section class="control-group">
@@ -46,7 +46,7 @@
                     <span>Code Peek</span>
                 </div>
                 <p class="control-note">
-                    Open the detailed view of any block to use the Show Code toggle for source context.
+                    Use the code panel to view source context for the active operation.
                 </p>
             </section>
             <div id="op-code-panel" class="op-code-panel"></div>
@@ -54,7 +54,6 @@
 
         <div id="sidebar-resizer" class="sidebar-resizer" role="separator" aria-orientation="vertical" tabindex="0"></div>
         <main id="canvas-wrapper">
-            <canvas id="canvas" aria-label="Kernel Visualization Canvas"></canvas>
             <div id="visualization-container"></div>
         </main>
     </div>

file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}
diff --git a/triton_viz/templates/index.html b/triton_viz/templates/index.html
index 4b4b4edb219e7846c77e4c734030087ecb31f6aa..8197842b0f2d159ac3c34fb43c154443556d8e29
--- a/triton_viz/templates/index.html
+++ b/triton_viz/templates/index.html
@@ -13,7 +13,7 @@
                 <div class="title-block">
                     <span class="eyebrow">Triton Viz</span>
                     <h1>Kernel Explorer</h1>
-                    <p class="control-note">Filter program IDs, move across slices, and jump into overview mode.</p>
+                    <p class="control-note">Filter program IDs and explore the active program workspace.</p>
                 </div>
                 <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                     <span id="theme-toggle-icon" aria-hidden="true">â˜€</span>
@@ -38,7 +38,7 @@
                     <button id="btn-op-all-programs" class="viz-button ghost" type="button" disabled>All Program IDs: OFF</button>
                     <button id="btn-op-histogram" class="viz-button ghost" type="button" disabled>Value Histogram</button>
                 </div>
-                <p class="control-note">Open a block to enable operation controls.</p>
+                <p class="control-note">Operation controls follow the active program selection.</p>
             </section>
 
             <section class="control-group">
@@ -46,7 +46,7 @@
                     <span>Code Peek</span>
                 </div>
                 <p class="control-note">
-                    Open the detailed view of any block to use the Show Code toggle for source context.
+                    Use the code panel to view source context for the active operation.
                 </p>
             </section>
             <div id="op-code-panel" class="op-code-panel"></div>
@@ -54,7 +54,6 @@
 
         <div id="sidebar-resizer" class="sidebar-resizer" role="separator" aria-orientation="vertical" tabindex="0"></div>
         <main id="canvas-wrapper">
-            <canvas id="canvas" aria-label="Kernel Visualization Canvas"></canvas>
             <div id="visualization-container"></div>
         </main>
     </div>


thinking
**Updating CSS for visualization adjustments**

I'm preparing to remove the `body.tensor-only #canvas` block and `#canvas` styles while updating `#visualization-container` to use relative positioning and `.detail-overlay` to fill absolutely, adjusting their layout accordingly. Next, I'll apply these CSS changes via a patch.
exec
/bin/bash -lc "rg -n \"tensor-only|#canvas\\b|#visualization-container|detail-overlay\" -n triton_viz/static/visualizer.css" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
84:body.tensor-only #canvas {
351:#canvas-wrapper {
357:#canvas {
363:#visualization-container {
400:.detail-overlay {
415:.detail-overlay .detail-card {
459:.detail-overlay .overlay-title-row {
756:    #canvas-wrapper {
764:    .detail-overlay {
file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}
diff --git a/triton_viz/templates/index.html b/triton_viz/templates/index.html
index 4b4b4edb219e7846c77e4c734030087ecb31f6aa..8197842b0f2d159ac3c34fb43c154443556d8e29
--- a/triton_viz/templates/index.html
+++ b/triton_viz/templates/index.html
@@ -13,7 +13,7 @@
                 <div class="title-block">
                     <span class="eyebrow">Triton Viz</span>
                     <h1>Kernel Explorer</h1>
-                    <p class="control-note">Filter program IDs, move across slices, and jump into overview mode.</p>
+                    <p class="control-note">Filter program IDs and explore the active program workspace.</p>
                 </div>
                 <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                     <span id="theme-toggle-icon" aria-hidden="true">â˜€</span>
@@ -38,7 +38,7 @@
                     <button id="btn-op-all-programs" class="viz-button ghost" type="button" disabled>All Program IDs: OFF</button>
                     <button id="btn-op-histogram" class="viz-button ghost" type="button" disabled>Value Histogram</button>
                 </div>
-                <p class="control-note">Open a block to enable operation controls.</p>
+                <p class="control-note">Operation controls follow the active program selection.</p>
             </section>
 
             <section class="control-group">
@@ -46,7 +46,7 @@
                     <span>Code Peek</span>
                 </div>
                 <p class="control-note">
-                    Open the detailed view of any block to use the Show Code toggle for source context.
+                    Use the code panel to view source context for the active operation.
                 </p>
             </section>
             <div id="op-code-panel" class="op-code-panel"></div>
@@ -54,7 +54,6 @@
 
         <div id="sidebar-resizer" class="sidebar-resizer" role="separator" aria-orientation="vertical" tabindex="0"></div>
         <main id="canvas-wrapper">
-            <canvas id="canvas" aria-label="Kernel Visualization Canvas"></canvas>
             <div id="visualization-container"></div>
         </main>
     </div>

exec
/bin/bash -lc "sed -n '70,120p' triton_viz/static/visualizer.css" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 50ms:
    font-family: var(--font-sans);
    background: var(--app-bg);
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
}

.viz-app {
    display: grid;
    grid-template-columns: var(--sidebar-width) var(--sidebar-resizer-width) 1fr;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
}

body.tensor-only #canvas {
    display: none;
}

#control-panel {
    padding: 28px 32px 32px;
file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}
diff --git a/triton_viz/templates/index.html b/triton_viz/templates/index.html
index 4b4b4edb219e7846c77e4c734030087ecb31f6aa..8197842b0f2d159ac3c34fb43c154443556d8e29
--- a/triton_viz/templates/index.html
+++ b/triton_viz/templates/index.html
@@ -13,7 +13,7 @@
                 <div class="title-block">
                     <span class="eyebrow">Triton Viz</span>
                     <h1>Kernel Explorer</h1>
-                    <p class="control-note">Filter program IDs, move across slices, and jump into overview mode.</p>
+                    <p class="control-note">Filter program IDs and explore the active program workspace.</p>
                 </div>
                 <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                     <span id="theme-toggle-icon" aria-hidden="true">â˜€</span>
@@ -38,7 +38,7 @@
                     <button id="btn-op-all-programs" class="viz-button ghost" type="button" disabled>All Program IDs: OFF</button>
                     <button id="btn-op-histogram" class="viz-button ghost" type="button" disabled>Value Histogram</button>
                 </div>
-                <p class="control-note">Open a block to enable operation controls.</p>
+                <p class="control-note">Operation controls follow the active program selection.</p>
             </section>
 
             <section class="control-group">
@@ -46,7 +46,7 @@
                     <span>Code Peek</span>
                 </div>
                 <p class="control-note">
-                    Open the detailed view of any block to use the Show Code toggle for source context.
+                    Use the code panel to view source context for the active operation.
                 </p>
             </section>
             <div id="op-code-panel" class="op-code-panel"></div>
@@ -54,7 +54,6 @@
 
         <div id="sidebar-resizer" class="sidebar-resizer" role="separator" aria-orientation="vertical" tabindex="0"></div>
         <main id="canvas-wrapper">
-            <canvas id="canvas" aria-label="Kernel Visualization Canvas"></canvas>
             <div id="visualization-container"></div>
         </main>
     </div>


thinking
**Removing tensor-only block near canvas-wrapper**
exec
/bin/bash -lc "sed -n '340,430p' triton_viz/static/visualizer.css" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
.detail-open #control-panel .panel-header,
.detail-open #control-panel .control-group:not(.is-program-ids):not(.is-op-controls),
.detail-open #control-panel .control-note {
    display: none;
}

.detail-open #control-panel {
    gap: 20px;
    padding-top: 24px;
}

#canvas-wrapper {
    position: relative;
    background: var(--canvas-bg);
    overflow: hidden;
}

#canvas {
    width: 100%;
    height: 100%;
file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}
diff --git a/triton_viz/templates/index.html b/triton_viz/templates/index.html
index 4b4b4edb219e7846c77e4c734030087ecb31f6aa..8197842b0f2d159ac3c34fb43c154443556d8e29
--- a/triton_viz/templates/index.html
+++ b/triton_viz/templates/index.html
@@ -13,7 +13,7 @@
                 <div class="title-block">
                     <span class="eyebrow">Triton Viz</span>
                     <h1>Kernel Explorer</h1>
-                    <p class="control-note">Filter program IDs, move across slices, and jump into overview mode.</p>
+                    <p class="control-note">Filter program IDs and explore the active program workspace.</p>
                 </div>
                 <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                     <span id="theme-toggle-icon" aria-hidden="true">â˜€</span>
@@ -38,7 +38,7 @@
                     <button id="btn-op-all-programs" class="viz-button ghost" type="button" disabled>All Program IDs: OFF</button>
                     <button id="btn-op-histogram" class="viz-button ghost" type="button" disabled>Value Histogram</button>
                 </div>
-                <p class="control-note">Open a block to enable operation controls.</p>
+                <p class="control-note">Operation controls follow the active program selection.</p>
             </section>
 
             <section class="control-group">
@@ -46,7 +46,7 @@
                     <span>Code Peek</span>
                 </div>
                 <p class="control-note">
-                    Open the detailed view of any block to use the Show Code toggle for source context.
+                    Use the code panel to view source context for the active operation.
                 </p>
             </section>
             <div id="op-code-panel" class="op-code-panel"></div>
@@ -54,7 +54,6 @@
 
         <div id="sidebar-resizer" class="sidebar-resizer" role="separator" aria-orientation="vertical" tabindex="0"></div>
         <main id="canvas-wrapper">
-            <canvas id="canvas" aria-label="Kernel Visualization Canvas"></canvas>
             <div id="visualization-container"></div>
         </main>
     </div>

Reconnecting... 1/5 (stream disconnected before completion: Rate limit reached for gpt-5.2-codex in organization org-c0kECLeR35XJgKeB71QUU7E3 on tokens per min (TPM): Limit 500000, Used 444582, Requested 62467. Please try again in 845ms. Visit https://platform.openai.com/account/rate-limits to learn more.)

thinking
**Noting responsive section check**

I'll review the responsive section near line 756 to identify necessary adjustments.
exec
/bin/bash -lc "sed -n '730,790p' triton_viz/static/visualizer.css" in /home/trtx/College/keren/triton-viz/cr-frontend-1 succeeded in 51ms:
.is-dragging {
    cursor: grabbing;
}

.drag-handle {
    cursor: grab;
}

.drag-handle.is-dragging {
    cursor: grabbing;
}

@media (max-width: 1280px) {
    .viz-app {
        grid-template-columns: 1fr;
    }

    #control-panel {
        position: absolute;
        z-index: 1200;
file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}
diff --git a/triton_viz/templates/index.html b/triton_viz/templates/index.html
index 4b4b4edb219e7846c77e4c734030087ecb31f6aa..8197842b0f2d159ac3c34fb43c154443556d8e29
--- a/triton_viz/templates/index.html
+++ b/triton_viz/templates/index.html
@@ -13,7 +13,7 @@
                 <div class="title-block">
                     <span class="eyebrow">Triton Viz</span>
                     <h1>Kernel Explorer</h1>
-                    <p class="control-note">Filter program IDs, move across slices, and jump into overview mode.</p>
+                    <p class="control-note">Filter program IDs and explore the active program workspace.</p>
                 </div>
                 <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                     <span id="theme-toggle-icon" aria-hidden="true">â˜€</span>
@@ -38,7 +38,7 @@
                     <button id="btn-op-all-programs" class="viz-button ghost" type="button" disabled>All Program IDs: OFF</button>
                     <button id="btn-op-histogram" class="viz-button ghost" type="button" disabled>Value Histogram</button>
                 </div>
-                <p class="control-note">Open a block to enable operation controls.</p>
+                <p class="control-note">Operation controls follow the active program selection.</p>
             </section>
 
             <section class="control-group">
@@ -46,7 +46,7 @@
                     <span>Code Peek</span>
                 </div>
                 <p class="control-note">
-                    Open the detailed view of any block to use the Show Code toggle for source context.
+                    Use the code panel to view source context for the active operation.
                 </p>
             </section>
             <div id="op-code-panel" class="op-code-panel"></div>
@@ -54,7 +54,6 @@
 
         <div id="sidebar-resizer" class="sidebar-resizer" role="separator" aria-orientation="vertical" tabindex="0"></div>
         <main id="canvas-wrapper">
-            <canvas id="canvas" aria-label="Kernel Visualization Canvas"></canvas>
             <div id="visualization-container"></div>
         </main>
     </div>

Reconnecting... 1/5 (stream disconnected before completion: Rate limit reached for gpt-5.2-codex in organization org-c0kECLeR35XJgKeB71QUU7E3 on tokens per min (TPM): Limit 500000, Used 455638, Requested 62889. Please try again in 2.223s. Visit https://platform.openai.com/account/rate-limits to learn more.)

thinking
**Planning CSS overlay and container updates**

Deciding to remove certain obsolete CSS blocks and update the visualization container and detail overlay styles to use absolute positioning with full width/height and consistent pointer events, simplifying media query widths and preserving existing z-index and detail-open styles for safety.
file update
M /home/trtx/College/keren/triton-viz/cr-frontend-1/triton_viz/static/visualizer.css
@@ -83,6 +83,2 @@
 
-body.tensor-only #canvas {
-    display: none;
-}
-
 #control-panel {
@@ -354,8 +350,2 @@
     overflow: hidden;
-}
-
-#canvas {
-    width: 100%;
-    height: 100%;
-    display: block;
 }
@@ -364,8 +354,7 @@
     position: absolute;
-    top: 0;
-    left: 0;
+    inset: 0;
     width: 100%;
     height: 100%;
-    pointer-events: none;
-    display: none;
+    pointer-events: auto;
+    display: block;
 }
@@ -400,7 +389,4 @@
 .detail-overlay {
-    position: fixed;
-    top: 0;
-    left: calc(var(--sidebar-width) + var(--sidebar-resizer-width));
-    width: calc(100vw - var(--sidebar-width) - var(--sidebar-resizer-width));
-    height: 100vh;
+    position: absolute;
+    inset: 0;
     background: #000;
@@ -764,4 +750,3 @@
     .detail-overlay {
-        left: 0;
-        width: 100vw;
+        width: 100%;
     }
apply_patch(auto_approved=true) exited 0 in 6ms:
Success. Updated the following files:
M /home/trtx/College/keren/triton-viz/cr-frontend-1/triton_viz/static/visualizer.css
file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
+                window.setOpControlState({ showCode: !!visible });
+            });
+        } else {
+            window.setOpControlState({ showCode: !!result });
+        }
+    }
+}
diff --git a/triton_viz/static/visualizer.css b/triton_viz/static/visualizer.css
index 7c83e02f5ec1512fac9e0e5e2aca332ae62a970f..a5930fd6e34c89aed39b056b6138da414d6ff03a
--- a/triton_viz/static/visualizer.css
+++ b/triton_viz/static/visualizer.css
@@ -81,10 +81,6 @@
     overflow: hidden;
 }
 
-body.tensor-only #canvas {
-    display: none;
-}
-
 #control-panel {
     padding: 28px 32px 32px;
     background: var(--panel-bg);
@@ -352,22 +348,15 @@
     position: relative;
     background: var(--canvas-bg);
     overflow: hidden;
-}
-
-#canvas {
-    width: 100%;
-    height: 100%;
-    display: block;
 }
 
 #visualization-container {
     position: absolute;
-    top: 0;
-    left: 0;
+    inset: 0;
     width: 100%;
     height: 100%;
-    pointer-events: none;
-    display: none;
+    pointer-events: auto;
+    display: block;
 }
 
 .viz-stage {
@@ -398,11 +387,8 @@
 }
 
 .detail-overlay {
-    position: fixed;
-    top: 0;
-    left: calc(var(--sidebar-width) + var(--sidebar-resizer-width));
-    width: calc(100vw - var(--sidebar-width) - var(--sidebar-resizer-width));
-    height: 100vh;
+    position: absolute;
+    inset: 0;
     background: #000;
     z-index: 2000;
     display: flex;
@@ -762,8 +748,7 @@
     }
 
     .detail-overlay {
-        left: 0;
-        width: 100vw;
+        width: 100%;
     }
 }
 #sidebar-resizer {
diff --git a/triton_viz/templates/index.html b/triton_viz/templates/index.html
index 4b4b4edb219e7846c77e4c734030087ecb31f6aa..8197842b0f2d159ac3c34fb43c154443556d8e29
--- a/triton_viz/templates/index.html
+++ b/triton_viz/templates/index.html
@@ -13,7 +13,7 @@
                 <div class="title-block">
                     <span class="eyebrow">Triton Viz</span>
                     <h1>Kernel Explorer</h1>
-                    <p class="control-note">Filter program IDs, move across slices, and jump into overview mode.</p>
+                    <p class="control-note">Filter program IDs and explore the active program workspace.</p>
                 </div>
                 <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                     <span id="theme-toggle-icon" aria-hidden="true">â˜€</span>
@@ -38,7 +38,7 @@
                     <button id="btn-op-all-programs" class="viz-button ghost" type="button" disabled>All Program IDs: OFF</button>
                     <button id="btn-op-histogram" class="viz-button ghost" type="button" disabled>Value Histogram</button>
                 </div>
-                <p class="control-note">Open a block to enable operation controls.</p>
+                <p class="control-note">Operation controls follow the active program selection.</p>
             </section>
 
             <section class="control-group">
@@ -46,7 +46,7 @@
                     <span>Code Peek</span>
                 </div>
                 <p class="control-note">
-                    Open the detailed view of any block to use the Show Code toggle for source context.
+                    Use the code panel to view source context for the active operation.
                 </p>
             </section>
             <div id="op-code-panel" class="op-code-panel"></div>
@@ -54,7 +54,6 @@
 
         <div id="sidebar-resizer" class="sidebar-resizer" role="separator" aria-orientation="vertical" tabindex="0"></div>
         <main id="canvas-wrapper">
-            <canvas id="canvas" aria-label="Kernel Visualization Canvas"></canvas>
             <div id="visualization-container"></div>
         </main>
     </div>

file update:
diff --git a/triton_viz/static/op_workspace.js b/triton_viz/static/op_workspace.js
new file mode 100644
index 0000000000000000000000000000000000000000..5799d6456c725777906856842286786babb9ed5a
--- /dev/null
+++ b/triton_viz/static/op_workspace.js
@@ -0,0 +1,408 @@
+import { createMatMulVisualization } from './matmul.js';
+import { createLoadVisualization } from './load.js';
+import { createStoreVisualization } from './store.js';
+import { createFlowDiagram } from './nki.js';
+import { enableDrag } from './ui_helpers.js';
+
+export class OpWorkspace {
+    constructor(containerElement, { getBlockData = null, maxValues = { x: 0, y: 0, z: 0 } } = {}) {
+        this.containerElement = containerElement;
+        this.getBlockData = getBlockData;
+        this.maxValues = maxValues;
+        this.gridPosition = { x: 0, y: 0, z: 0 };
+        this.blockData = [];
+        this.visualizationContainer = null;
+        this.visualizationCleanupFunction = null;
+        this.contentArea = null;
+        this.activeTab = null;
+        this.activeTabIndex = 0;
+        this.lastOpType = null;
+        this.titleEl = null;
+        this.badgeEl = null;
+        this.cardEl = null;
+        this.headerBar = null;
+        this.initialize();
+    }
+
+    initialize() {
+        if (!this.containerElement) return;
+        this.visualizationContainer = this.createVisualizationContainer();
+        const card = document.createElement('div');
+        card.className = 'detail-card';
+        this.cardEl = card;
+
+        const titleRow = this.createTitleRow();
+        this.headerBar = this.createHeaderBar();
+        this.contentArea = this.createContentArea();
+
+        card.appendChild(titleRow);
+        card.appendChild(this.headerBar);
+        card.appendChild(this.contentArea);
+        this.visualizationContainer.appendChild(card);
+
+        this.containerElement.innerHTML = '';
+        this.containerElement.appendChild(this.visualizationContainer);
+        this.containerElement.style.display = 'block';
+        this.containerElement.style.pointerEvents = 'auto';
+
+        this.ensureGlobalCodeToggle();
+        try {
+            window.__tritonVizActiveBlock = this;
+        } catch (error) {}
+    }
+
+    setProgram(x, y, z, { force = false } = {}) {
+        const max = this.maxValues || { x: 0, y: 0, z: 0 };
+        const nx = Math.max(0, Math.min(max.x ?? 0, x));
+        const ny = Math.max(0, Math.min(max.y ?? 0, y));
+        const nz = Math.max(0, Math.min(max.z ?? 0, z));
+        const changed = nx !== this.gridPosition.x || ny !== this.gridPosition.y || nz !== this.gridPosition.z;
+        if (!changed && !force) return;
+        this.gridPosition = { x: nx, y: ny, z: nz };
+        if (this.getBlockData) {
+            this.blockData = this.getBlockData(nx, ny, nz);
+        } else {
+            this.blockData = [];
+        }
+        if (changed) {
+            console.info('Active program changed', { x: nx, y: ny, z: nz });
+            if (window.resetOpControls) window.resetOpControls();
+        }
+        if (this.titleEl) {
+            this.titleEl.textContent = `Program (${nx}, ${ny}, ${nz})`;
+        }
+        if (this.badgeEl) {
+            this.badgeEl.textContent = `${this.blockData.length} ops`;
+        }
+        if (this.headerBar && this.cardEl) {
+            this.headerBar.remove();
+            this.headerBar = this.createHeaderBar();
+            this.cardEl.insertBefore(this.headerBar, this.contentArea);
+        }
+        if (this.blockData.length > 0) {
+            const nextIndex = Math.min(this.activeTabIndex || 0, this.blockData.length - 1);
+            this.activeTabIndex = nextIndex;
+            this.displayOpVisualization(this.blockData[nextIndex], {
+                refreshCodePanel: false,
+                preserveViewState: true,
+                logTabChange: true,
+            });
+        } else {
+            this.renderEmptyState();
+        }
+    }
+
+    createVisualizationContainer() {
+        const container = document.createElement('div');
+        container.className = 'detail-overlay';
+        return container;
+    }
+
+    createTitleRow() {
+        const row = document.createElement('div');
+        row.className = 'overlay-title-row';
+        const title = document.createElement('h2');
+        title.className = 'detail-title';
+        title.textContent = `Program (${this.gridPosition.x}, ${this.gridPosition.y}, ${this.gridPosition.z})`;
+        const badge = document.createElement('span');
+        badge.className = 'badge';
+        badge.textContent = `${this.blockData.length} ops`;
+        row.appendChild(title);
+        row.appendChild(badge);
+        this.titleEl = title;
+        this.badgeEl = badge;
+        return row;
+    }
+
+    createHeaderBar() {
+        const headerBar = document.createElement('div');
+        headerBar.className = 'detail-tabs';
+        this.activeTab = null;
+
+        let defaultTab = null;
+        let preferredTab = null;
+        this.blockData.forEach((op, index) => {
+            const opTab = this.createOperationTab(op);
+            opTab.addEventListener('click', () => this.handleTabClick(opTab, op, index));
+            headerBar.appendChild(opTab);
+            if (index === 0) {
+                defaultTab = opTab;
+            }
+            if (this.activeTabIndex === index) {
+                preferredTab = opTab;
+            }
+        });
+        if (preferredTab) {
+            this.setActiveTab(preferredTab);
+        } else if (defaultTab) {
+            this.setActiveTab(defaultTab);
+        }
+
+        const flowTab = this.createTabButton('Flow');
+        flowTab.addEventListener('click', () => {
+            this.setActiveTab(flowTab);
+            this.displayFlowDiagram({ logTabChange: true });
+        });
+        headerBar.appendChild(flowTab);
+
+        return headerBar;
+    }
+
+    createOperationTab(op) {
+        const pieces = [
+            op.type,
+            (op.global_shape || []).join('Ã—'),
+            typeof op.overall_key === 'string' ? op.overall_key : ''
+        ].filter(Boolean);
+        const tab = this.createTabButton(pieces.join(' â€¢ '));
+        return tab;
+    }
+
+    createTabButton(label) {
+        const btn = document.createElement('button');
+        btn.className = 'detail-tab';
+        btn.textContent = label;
+        return btn;
+    }
+
+    setActiveTab(tab) {
+        if (this.activeTab === tab) return;
+        if (this.activeTab) {
+            this.activeTab.classList.remove('is-active');
+        }
+        this.activeTab = tab;
+        if (this.activeTab) {
+            this.activeTab.classList.add('is-active');
+        }
+    }
+
+    handleTabClick(clickedTab, op, index = null) {
+        this.setActiveTab(clickedTab);
+        if (typeof index === 'number') {
+            this.activeTabIndex = index;
+        }
+        this.displayOpVisualization(op, { preserveViewState: true, logTabChange: true });
+    }
+
+    createContentArea() {
+        const contentArea = document.createElement('div');
+        contentArea.className = 'detail-content';
+        if (this.blockData.length === 0) {
+            const empty = document.createElement('div');
+            empty.className = 'overall-empty';
+            empty.textContent = 'No operation data available.';
+            contentArea.appendChild(empty);
+        }
+        return contentArea;
+    }
+
+    renderEmptyState() {
+        if (!this.contentArea) return;
+        this.contentArea.innerHTML = '';
+        const empty = document.createElement('div');
+        empty.className = 'overall-empty';
+        empty.textContent = 'No operation data available.';
+        this.contentArea.appendChild(empty);
+        if (window.resetOpControls) window.resetOpControls();
+    }
+
+    logTabChange(opType) {
+        console.info('Op tab changed', {
+            program: {
+                x: this.gridPosition.x,
+                y: this.gridPosition.y,
+                z: this.gridPosition.z,
+            },
+            opType,
+        });
+    }
+
+    displayOpVisualization(op, options = {}) {
+        if (!this.contentArea) {
+            console.error('Content area is not initialized');
+            return;
+        }
+        let viewState = options.viewState || null;
+        const canReuseViz = options.preserveViewState && this.contentArea.__vizGetState;
+        if (!viewState && canReuseViz) {
+            viewState = this.contentArea.__vizGetState();
+        }
+        const preserveCodePanel = options.refreshCodePanel === false;
+        if (preserveCodePanel) {
+            try { window.__tritonVizPreserveCodePanel = true; } catch (error) {}
+        }
+        const isTensorOp = op.type === 'Dot' || op.type === 'Load' || op.type === 'Store';
+        const reuseTensorView = canReuseViz && isTensorOp && this.lastOpType === op.type;
+        try {
+            if (!reuseTensorView && this.visualizationCleanupFunction) {
+                this.visualizationCleanupFunction();
+                this.visualizationCleanupFunction = null;
+            }
+        } finally {
+            if (preserveCodePanel) {
+                try { window.__tritonVizPreserveCodePanel = false; } catch (error) {}
+            }
+        }
+        if (!reuseTensorView) {
+            this.contentArea.innerHTML = '';
+        }
+        try {
+            window.last_op = op;
+            window.last_op_global_shape = op.global_shape;
+            window.last_global_coords = op.global_coords;
+            window.last_slice_shape = op.slice_shape;
+            window.last_slice_coords = op.slice_coords;
+        } catch (error) { /* noop */ }
+
+        switch (op.type) {
+            case 'Dot':
+                this.visualizationCleanupFunction = createMatMulVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Load':
+                this.visualizationCleanupFunction = createLoadVisualization(this.contentArea, op, viewState);
+                break;
+            case 'Store':
+                this.visualizationCleanupFunction = createStoreVisualization(this.contentArea, op, viewState);
+                break;
+            default:
+                this.contentArea.textContent = `Visualization not supported for ${op.type} operations.`;
+        }
+        this.lastOpType = op.type;
+        if (options.logTabChange) {
+            this.logTabChange(op.type);
+        }
+        if (options.refreshCodePanel !== false) {
+            this.syncCodePanel(true);
+        }
+    }
+
+    displayFlowDiagram({ logTabChange = false } = {}) {
+        if (!this.contentArea) return;
+        if (this.visualizationCleanupFunction) {
+            this.visualizationCleanupFunction();
+            this.visualizationCleanupFunction = null;
+        }
+        this.contentArea.innerHTML = '';
+        this.visualizationCleanupFunction = createFlowDiagram(this.contentArea, this.blockData || []);
+        if (logTabChange) {
+            this.logTabChange('Flow');
+        }
+    }
+
+    ensureGlobalCodeToggle() {
+        if (window.__tritonVizCodeToggle) return;
+        let panel = null;
+        let visible = false;
+
+        const destroyPanel = () => {
+            if (panel && panel.remove) panel.remove();
+            const host = document.getElementById('op-code-panel');
+            if (host && host.contains(panel)) {
+                host.innerHTML = '';
+            }
+            panel = null;
+        };
+
+        const getActiveUuid = () => {
+            const activeBlock = window.__tritonVizActiveBlock;
+            return window.current_op_uuid || (activeBlock && activeBlock.blockData && activeBlock.blockData[0] && activeBlock.blockData[0].uuid);
+        };
+
+        const createPanel = async (uuid, frameIdx = 0, context = 8) => {
+            destroyPanel();
+            const wrapper = document.createElement('div');
+            wrapper.className = 'show-code-panel';
+            const header = document.createElement('div');
+            header.className = 'panel-header drag-handle';
+            header.style.fontWeight = '600';
+            header.style.marginBottom = '8px';
+            header.innerHTML = '<span>Code View</span><span class="drag-grip" aria-hidden="true">â ¿</span>';
+            wrapper.appendChild(header);
+            const blurb = document.createElement('div');
+            blurb.style.fontSize = '12px';
+            blurb.style.color = 'var(--text-secondary)';
+            blurb.style.marginBottom = '8px';
+            blurb.textContent = 'Arrow points to the line being visualized.';
+            wrapper.appendChild(blurb);
+            try {
+                const API_BASE = window.__TRITON_VIZ_API__ || '';
+                const res = await fetch(`${API_BASE}/api/op_code`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({ uuid, frame_idx: frameIdx, context })
+                });
+                const data = await res.json();
+                const meta = document.createElement('div');
+                meta.style.marginBottom = '6px';
+                meta.style.fontSize = '12px';
+                meta.textContent = `${data.filename || ''}:${data.lineno || ''}`;
+                wrapper.appendChild(meta);
+                const pre = document.createElement('pre');
+                pre.style.margin = '0';
+                const lines = (data.lines || []).map((line) => {
+                    const mark = (data.highlight === line.no) ? 'â–¶ ' : '  ';
+                    return `${mark}${String(line.no).padStart(6, ' ')} | ${line.text || ''}`;
+                }).join('\n');
+                pre.textContent = lines || '(no code available)';
+                wrapper.appendChild(pre);
+            } catch (error) {
+                const err = document.createElement('div');
+                err.textContent = 'Failed to load code context.';
+                wrapper.appendChild(err);
+            }
+            const host = document.getElementById('op-code-panel');
+            if (host) {
+                host.innerHTML = '';
+                wrapper.classList.add('is-sidebar');
+                host.appendChild(wrapper);
+            } else {
+                document.body.appendChild(wrapper);
+                enableDrag(wrapper, { handle: header, bounds: window });
+            }
+            panel = wrapper;
+        };
+
+        const togglePanel = async (force) => {
+            const next = typeof force === 'boolean' ? force : !visible;
+            if (!next) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            const activeUuid = getActiveUuid();
+            if (!activeUuid) {
+                visible = false;
+                destroyPanel();
+                return visible;
+            }
+            visible = true;
+            await createPanel(activeUuid, 0, 8);
+            return visible;
+        };
+
+        const hidePanel = () => {
+            visible = false;
+            destroyPanel();
+            return visible;
+        };
+
+        window.__tritonVizCodeToggle = togglePanel;
+        window.__tritonVizCodeHide = hidePanel;
+        window.__tritonVizCodeVisible = () => visible;
+    }
+
+    syncCodePanel(forceShow = false) {
+        if (!window.__tritonVizCodeToggle) return;
+        const isVisible = window.__tritonVizCodeVisible ? window.__tritonVizCodeVisible() : false;
+        if (!forceShow && !isVisible) return;
+        const result = window.__tritonVizCodeToggle(true);
+        if (!window.setOpControlState) return;
+        if (result && typeof result.then === 'function') {
+            result.then((visible) => {
